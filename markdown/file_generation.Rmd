---
title: "USHE Student File Submission"
author: Craig Demke
output: html_document
date: "`r Sys.Date()`"
---

```{r set global chunks, include=FALSE}
knitr::opts_chunk$set(
  warning = FALSE, message = FALSE
)
```

### File Description 
* The Students Data Submission File contains demographic records for all the students for a particular extract. It is submitted five 
times per fiscal year (Summer End of Term (EOT), Fall 3rd Week, Fall EOT, Spring 3rd Week, and Spring End of Term EOT.

* This information is found in **Edify** Utah Tech's data-warehouse and is complied using R package **usheUtils**     

# {.tabset}


## Walk though 



load these libraries
```{r load libraries}
library(tidyverse)
library(datasets)
library(DT)
library(here)
library(utHelpR)
library(usheUtils)
```

Here we are using the **utHelp** package with the **get_data_from_sql_file** function. 
```{r, echo = FALSE}
student_file <- utHelpR::get_data_from_sql_file(file_name="student_file_with_versioning.sql",
                                               dsn="edify",
                                               context="project")
```

Here is where you pick the term and version you want to use.

* term is the year (YYYY) + the semester where 30 = summer, 40 = fall, 20 = spring

* version is the snapshot data at any given time during the semester: Current = current, Census = 3rd week, and End of Term = end of term. 
```{r}
term <- '202220' # replace this with the term you want to report on
version <- 'Current' # replace this with the version you want to report on

student_file <- student_file %>% 
  filter(term_id == term & version_desc == version)
```
  
Here we will see what each **usheUtils** function for the USHE Student file Submission, 

```{r}

student_file_check <- student_file %>%  
  s_01() %>% # Institution
  s_02() %>% # Year, Term, & Extract
  # s_03() %>%
  # s_04() %>%
  # s_05() %>%
  # s_06() %>%
  # s_07() %>%
  # s_08() %>%
  # s_09() %>%
  # s_10() %>%
  # s_11() %>%
  s_12() %>%  # Birth Date
 #s_13() %>%
  s_14() #%>% # Ethnic Origin
  # s_15() %>%
  # s_16() %>%
  # s_17() %>%
  # s_18() %>%
  # s_19() %>%
  # s_20() %>%
  # s_21() %>%
  # s_22() %>%
  # s_23() %>%
  # s_24() %>%
  # s_25() %>%
  # s_26() %>%
  # s_27() %>%
  # s_28() %>%
  # s_29() %>%
  # s_30() %>%
  # s_31() %>%
  # s_32() %>%
  # s_33() %>%
  # s_34() %>%
  # s_35() %>%
  # s_36() %>%
  # s_37() %>%
  # s_38() %>%
  # s_39() %>%
  # s_40() %>%
  # s_41() %>%
  # s_42() %>%
  # s_43() %>%
  # s_44() %>%
  # s_45()

```
These data points can be checked using the USHE documentation found in the Office of Institutional Effectiveness shared Google drive (https://docs.google.com/document/d/1C8QkgIpr7Qc6C--vXvdNXFX0ILFP9Gzl0cFUC-I72uo/edit)

```{r}
#DT::datatable(student_file_check, rownames=FALSE)
```

## Generate the script
This tab runs all the functions, and outputs the file to send to USHE.

```{r}
student_file_complete <- generate_student_submission_file(student_file)

```
here you can see what it will look like
```{r}
DT::datatable(student_file_complete, rownames=FALSE)
```


## USHE return file

Not sure what this is yet.

## SQL
Here is the sql used for these functions...
```{}
/* Student File with versioning */
   SELECT c.season,
          a.student_id,
          b.ssn,
          b.previous_student_id,
          b.last_name,
          b.first_name,
          b.last_name,
          b.middle_name,
          b.previous_last_name,
          b.preferred_first_name,
          b.previous_middle_name,
          b.local_address_zip_code,
          b.mailing_address_zip_code,
          b.us_citizenship_code,
          b.first_admit_county_code,
          b.first_admit_state_code,
          b.first_admit_country_code,
          b.birth_date,
          b.gender_code,
          b.is_hispanic_latino_ethnicity,
          b.is_asian,
          b.is_black,
          b.is_american_indian_alaskan,
          b.is_hawaiian_pacific_islander,
          b.is_white,
          b.is_international,
          b.is_other_race,
          a.residency_code,
          a.primary_major_cip_code,
          a.student_type_code,
          a.primary_level_class_id,
          a.primary_degree_id,
          a.institutional_cumulative_credits_earned,
          a.institutional_cumulative_gpa,
          COALESCE(a.transfer_cumulative_credits_earned, 0) AS transfer_cumulative_credits_earned,
          a.full_time_part_time_code,
          b.first_admit_country_iso_code,
          a.house_bill_75_waiver,
          a.secondary_major_cip_code,
          COALESCE(a.total_cumulative_ap_credits_earned, 0) AS total_cumulative_ap_credits_earned,
          COALESCE(a.total_cumulative_clep_credits_earned, 0) AS total_cumulative_clep_credits_earned,
          b.act_composite_score,
          b.act_english_score,
          b.act_math_score,
          b.act_reading_score,
          b.act_science_score,
          b.high_school_code,
          b.high_school_desc,
          b.high_school_graduation_date,
          a.is_pell_eligible,
          a.is_pell_awarded,
          a.is_bia,
          a.primary_major_college_id,
          a.primary_major_college_desc,
          a.secondary_major_college_id,
          a.secondary_major_college_desc,
          a.level_id,
          a.term_id,
          b.version_desc
     FROM export.student_term_level_version a
    LEFT JOIN export.term c
        ON a.term_id = c.term_id
    LEFT JOIN export.student_version b
       ON b.student_id = a.student_id
      AND b.version_snapshot_id = a.version_snapshot_id
    WHERE a.term_id >= (SELECT term_id FROM export.term WHERE is_previous_term)
      AND a.is_primary_level = TRUE
      AND a.is_enrolled = TRUE
 ORDER BY student_id;
```

## USHE Documentation on submission

### Submission Schedule 
* The file must be submitted to Utah Board of Higher Education as follows: 
+ Data 1st Submission Verification 
+ Summer EOT October 8th October 15th  
+ Fall 3rd Week September 24th October 1st 
+ Fall EOT January 14th January 21st 
+ Spring 3rd Week February 4th February 11th 
+ Spring EOT June 10th June 17th

### Capture Date 
* The capture date for each 3rd-Week extract is the 3rd-Week date of the Semester. The capture  date for each EOT is the end of the respective term. 

### Submission File Naming Convention 
* The Students Data Submission File should be named as follows: 
+ School short name (hyphen) file description (s for students) (hyphen) year/term extension  (093 for 2009 and third term) extract period (3 for 3rd-Week or E for EOT) .txt file  extension 
+ Example: wsu-s-0933.txt for Weber State University’s 3rd Week Students File for Spring  (2008-2009). 

### Delimiter
* The Students Data Submission File must be submitted in a pipe delimited format. A single pipe  symbol ‘|’ will be used as the delimiter. When submitting a delimited file, the pipe symbol must  appear between each field in the file (Note: some data elements will have multiple fields, e.g.  ethnicity has 8 fields).



Full USHE documentation can be found in the Office of Institutional Effectiveness shared Google drive (https://docs.google.com/document/d/1C8QkgIpr7Qc6C--vXvdNXFX0ILFP9Gzl0cFUC-I72uo/edit)