---
title: "USHE Student File Submission"
author: Craig Demke
output: html_document
date: "`r Sys.Date()`"
---

```{r set global chunks, include=FALSE}
knitr::opts_chunk$set(
  warning = FALSE, message = FALSE
)
```


# Introduction
Add text up here to explain what this file is, and how to use it. 

# {.tabset}

## Walk though

In this section we will pull in the data from Edify, and then pipe each function. The goal here is to enable someone to check the process at each step. 

load these libraries
```{r load libraries}
library(tidyverse)
library(datasets)
library(DT)
library(here)
library(utHelpR)
library(usheUtils)
```

Here we are using the utHelp package with the get_data_from_sql_file function. 
```{r, echo = FALSE}
student_file <- utHelpR::get_data_from_sql_file(file_name="student_file_with_versioning.sql",
                                               dsn="edify",
                                               context="project")
```

Here is where you pick the term and version you want to use
```{r}
term <- '202220'
version <- 'Current'

student_file <- student_file %>% 
  filter(term_id == term & version_desc == version)
```
  
Here we will see what each usheUtils function for the USHE Student file Submission,

```{r}

student_file_check <- student_file %>%  
  s_01() %>% # Institution
  s_02() %>% # Year, Term, & Extract
  # s_03() %>%
  # s_04() %>%
  # s_05() %>%
  # s_06() %>%
  # s_07() %>%
  # s_08() %>%
  # s_09() %>%
  # s_10() %>%
  # s_11() %>%
  s_12() %>%  # Birth Date
 #s_13() %>%
  s_14() #%>% # Ethnic Origin
  # s_15() %>%
  # s_16() %>%
  # s_17() %>%
  # s_18() %>%
  # s_19() %>%
  # s_20() %>%
  # s_21() %>%
  # s_22() %>%
  # s_23() %>%
  # s_24() %>%
  # s_25() %>%
  # s_26() %>%
  # s_27() %>%
  # s_28() %>%
  # s_29() %>%
  # s_30() %>%
  # s_31() %>%
  # s_32() %>%
  # s_33() %>%
  # s_34() %>%
  # s_35() %>%
  # s_36() %>%
  # s_37() %>%
  # s_38() %>%
  # s_39() %>%
  # s_40() %>%
  # s_41() %>%
  # s_42() %>%
  # s_43() %>%
  # s_44() %>%
  # s_45()

```
These data points can be checked using the USHE documentation found in the Office of Institutional Effectiveness shared google drive (https://docs.google.com/document/d/1C8QkgIpr7Qc6C--vXvdNXFX0ILFP9Gzl0cFUC-I72uo/edit)

```{r}
#DT::datatable(student_file_check, rownames=FALSE)
```

## Generate the script
This tab runs all the functions, and outputs the file to send to USHE.

```{r}
student_file_complete <- generate_student_submission_file(student_file)

```
here you can see what it will look like
```{r}
DT::datatable(student_file_complete, rownames=FALSE)
```


## USHE return file

Not sure what this is yet.

## SQL
Here is the sql used for these functions...
```{}
/* Student File with versioning */
   SELECT c.season,
          a.student_id,
          b.ssn,
          b.previous_student_id,
          b.last_name,
          b.first_name,
          b.last_name,
          b.middle_name,
          b.previous_last_name,
          b.preferred_first_name,
          b.previous_middle_name,
          b.local_address_zip_code,
          b.mailing_address_zip_code,
          b.us_citizenship_code,
          b.first_admit_county_code,
          b.first_admit_state_code,
          b.first_admit_country_code,
          b.birth_date,
          b.gender_code,
          b.is_hispanic_latino_ethnicity,
          b.is_asian,
          b.is_black,
          b.is_american_indian_alaskan,
          b.is_hawaiian_pacific_islander,
          b.is_white,
          b.is_international,
          b.is_other_race,
          a.residency_code,
          a.primary_major_cip_code,
          a.student_type_code,
          a.primary_level_class_id,
          a.primary_degree_id,
          a.institutional_cumulative_credits_earned,
          a.institutional_cumulative_gpa,
          COALESCE(a.transfer_cumulative_credits_earned, 0) AS transfer_cumulative_credits_earned,
          a.full_time_part_time_code,
          b.first_admit_country_iso_code,
          a.house_bill_75_waiver,
          a.secondary_major_cip_code,
          COALESCE(a.total_cumulative_ap_credits_earned, 0) AS total_cumulative_ap_credits_earned,
          COALESCE(a.total_cumulative_clep_credits_earned, 0) AS total_cumulative_clep_credits_earned,
          b.act_composite_score,
          b.act_english_score,
          b.act_math_score,
          b.act_reading_score,
          b.act_science_score,
          b.high_school_code,
          b.high_school_desc,
          b.high_school_graduation_date,
          a.is_pell_eligible,
          a.is_pell_awarded,
          a.is_bia,
          a.primary_major_college_id,
          a.primary_major_college_desc,
          a.secondary_major_college_id,
          a.secondary_major_college_desc,
          a.level_id,
          a.term_id,
          b.version_desc
     FROM export.student_term_level_version a
    LEFT JOIN export.term c
        ON a.term_id = c.term_id
    LEFT JOIN export.student_version b
       ON b.student_id = a.student_id
      AND b.version_snapshot_id = a.version_snapshot_id
    WHERE a.term_id >= (SELECT term_id FROM export.term WHERE is_previous_term)
      AND a.is_primary_level = TRUE
      AND a.is_enrolled = TRUE
 ORDER BY student_id;
```
